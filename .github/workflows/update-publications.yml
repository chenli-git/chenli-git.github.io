name: Update Publications from Google Scholar

on:
  schedule:
    - cron: '0 2 * * *'   # Runs daily at 02:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Fetch Google Scholar records
        uses: sxlllslgh/google-scholar-fetcher@v1
        id: scholar
        with:
          google-scholar-id: WvrzkYEAAAAJ
          record-file: docs/publications.json

      - name: Convert JSON to Markdown
        run: |
          pip install jq
          python - << 'EOF'
          import json

          # Load publication list
          data = json.load(open('docs/publications.json'))

          # Compute total citations
          total_cites = sum(int(p.get("cited_by", 0)) for p in data)

          md = "# Publications\n\n"
          md += f"**Total Citations:** {total_cites}\n\n"
          md += f"[Google Scholar Profile](https://scholar.google.com/citations?user=WvrzkYEAAAAJ)\n\n"
          md += "---\n\n"

          # Sort by year (descending)
          data_sorted = sorted(data, key=lambda x: x.get('date',''), reverse=True)

          current_year = None
          for p in data_sorted:
              year = p.get('date','')[:4]
              title = p.get('title','Untitled')
              link = p.get('link','')
              authors = p.get('authors','')
              journal = p.get('journal','')
              cites = p.get('cited_by', 0)

              # New year heading
              if year != current_year:
                  md += f"\n## {year}\n\n"
                  current_year = year

              # Publication entry
              md += f"- **[{title}]({link})**  \n"
              md += f"  *{authors}*  \n"
              md += f"  _{journal}_  \n"
              md += f"  **Citations:** {cites}\n\n"

          # Save file
          with open('docs/publications.md','w') as f:
              f.write(md)

          EOF

      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/publications.md
          if ! git diff --quiet --cached; then
            git commit -m "Auto-update publications with citation counts"
            git push
          else
            echo "No changes"
